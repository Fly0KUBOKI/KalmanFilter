# カスケードUKFシミュレーションシステム

3軸6軸センサから3次元速度・姿勢・位置をUKF（Unscented Kalman Filter）でカスケード推定するMATLABシミュレーションシステム

## システム概要

### センサ仕様
- **3軸加速度・角速度の6軸センサ**: 400Hz
- **3軸地磁気センサ**: 100Hz  
- **高度気圧センサ**: 50Hz
- **GPS**: 10Hz

### 推定内容
- **3次元速度**: 加速度から推定 (400Hz)
- **3次元姿勢**: 角速度、加速度、地磁気から推定 (100Hz)
- **3次元位置**: 速度、姿勢、気圧、GPSから推定 (10Hz)

### カスケード構造
- 速度推定プログラムが4回に1回姿勢推定を呼び出し
- 姿勢推定が10回に1回位置推定を呼び出し
- 各推定ブロックで予測・更新・推定を行い、結果を平均して次のブロックに渡す

## ファイル構成

### KalmanFilterフォルダ
```
kalman/KalmanFilter/
├── read_csv_data.m           # CSVファイル読み取り
├── UKF_Calculator.m          # UKFクラス（各推定ブロック独立）
├── velocity_estimator.m      # 速度推定ブロック
├── attitude_estimator.m      # 姿勢推定ブロック
├── position_estimator.m      # 位置推定ブロック
├── run_simulation.m          # フルシミュレーション実行
├── run_optimized_simulation.m # 最適化シミュレーション実行
├── run_small_simulation.m    # 小規模テスト実行
├── demo_simulation.m         # デモ実行（100ポイント）
├── plot_results.m           # リアルタイムプロット
├── plot_final_results.m     # 最終結果プロット
├── wrap_to_pi.m             # 角度正規化関数
└── テスト用ファイル群
    ├── simple_test.m
    ├── csv_test.m
    ├── read_csv_test.m
    ├── estimator_test.m
    └── test_components.m
```

### Graphフォルダ
```
kalman/Graph/
├── plot_simulation_results.m  # 詳細結果プロット
└── plot_cascade_results.m     # カスケード結果可視化
```

## 使用方法

### 1. 基本デモ実行（推奨）
```matlab
cd kalman/KalmanFilter
demo_simulation
```
100ポイントの短時間実行でシステム動作を確認

### 2. 小規模シミュレーション
```matlab
cd kalman/KalmanFilter  
run_small_simulation
```
1000ポイントでのテスト実行

### 3. 最適化シミュレーション（全データ）
```matlab
cd kalman/KalmanFilter
run_optimized_simulation
```
40,001ポイント全データでの完全実行（時間要）

### 4. 結果可視化
```matlab
cd kalman/Graph
plot_cascade_results
```
保存された結果の詳細プロット

## 設定パラメータ

### 推定頻度設定（run_simulation.m等で変更可能）
```matlab
VEL_FACTOR = 1;    % 速度推定頻度（毎回）
ATT_FACTOR = 4;    % 姿勢推定頻度（4回に1回）  
POS_FACTOR = 40;   % 位置推定頻度（40回に1回）
```

### ノイズパラメータ（config_params.mで設定）
- 各センサのノイズレベル
- プロセスノイズ設定
- 初期共分散設定

## システム特徴

### UKFクラス設計
- 各推定ブロックが独立したUKFインスタンスを持つ
- 異なる状態数・観測数に対応
- 数値安定性を考慮した実装

### メモリ効率化
- バッチ処理による大容量データ対応
- 間引きによる結果保存
- 異常値除去機能

### エラーハンドリング
- 基本的にエラーハンドリングなし（仕様通り）
- 実行時不定部分のみエラーハンドリング適用
- シンプルで最低限の実装

## 推定結果例

### デモ実行結果
```
最終速度推定: [0.007, 0.013, -2.546] m/s
最終姿勢推定: [0.004, -0.041, -0.453] rad  
最終位置推定: [-12.409, -6.238, -0.118] m
最終速度誤差: 2.7381 m/s
最終位置誤差: 6.1207 m
```

### 最適化シミュレーション結果
```
速度推定 - 平均誤差: 468.94 m/s
姿勢推定 - 平均Yaw誤差: 10.8 deg
位置推定 - 平均誤差: 32.0 m
```

## プロット仕様

### 速度プロット
- 真値（黒）、予測値（緑）、推定値（青）の速度ベクトル表示
- ベクトルは原点から表示

### 姿勢プロット  
- 真値（黒）、予測値（緑）、推定値（青）の姿勢ベクトル表示
- ベクトルは原点から表示

### 位置プロット
- 真値（黒）、推定値（青）の軌跡表示
- GPS（赤）、予測値（緑）は点で表示

## 技術仕様

### データ型
- float型使用（doubleではなく）
- 行列サイズは最小限に抑制

### 関数設計
- 一つの関数に一つの機能
- 複雑な機構は回避
- print文は最小限

### UKF実装
- シグマポイント法
- 数値安定性考慮
- Cholesky分解失敗時の代替処理

## トラブルシューティング

### 一般的な問題
1. **CSVファイルが見つからない**: `sim_data.csv`が正しい場所にあるか確認
2. **メモリ不足**: 小規模版から開始して徐々にサイズを拡大
3. **プロット失敗**: Statistics Toolboxが必要な関数がある場合は代替実装使用

### デバッグ用ツール
- `simple_test.m`: 基本機能確認
- `csv_test.m`: CSVデータ読み込み確認
- `estimator_test.m`: 各推定器の動作確認

## 今後の拡張

### 可能な改良点
1. 適応フィルタリング機能の追加
2. より高度なセンサフュージョン
3. リアルタイムプロセシング対応
4. パラメータ自動調整機能

### カスタマイズポイント
- ノイズモデルの変更
- 状態遷移モデルの改良
- 観測モデルの詳細化
- 異常値検出機能の追加

## 参考資料

- 既存の`kalman_filter.cpp`の構造を参考
- UKFアルゴリズムの標準実装
- センサフュージョン技術

---
作成日: 2025年10月10日
更新: カスケードUKFシミュレーションシステム v1.0